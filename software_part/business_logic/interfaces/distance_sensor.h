/**
 * @file    distance_sensor.h
 * @author  Olexandr Makedonskyi
 * @brief   Публічний інтерфейс датчика відстані для бізнес-логіки
 * @date    13.01.2026
 * @version 1.0
 * 
 * Модуль забезпечує високорівневий інтерфейс для роботи з
 * ультразвуковим датчиком відстані. Підтримує вимірювання
 * відстані та конвертацію в різні одиниці виміру.
 * 
 * Принцип роботи:
 * 1. Датчик посилає ультразвуковий імпульс
 * 2. Вимірюється час відбиття сигналу (echo)
 * 3. Час конвертується у відстань (см або дюйми)
 * 
 * Діапазон вимірювань:
 * - Мінімум: 2 см
 * - Максимум: 400 см (4 метри)
 * 
 * @note Цей файл призначений для використання в бізнес-логіці
 * @note Модуль абстрагує від конкретної реалізації датчика (HC-SR04)
 */

#ifndef __DISTANCE_INDICATION_H
#define __DISTANCE_INDICATION_H

//==================== INCLUDES ========================
#include "stm8s.h"

//==================== DEFINES =========================

/**
 * @brief Таймаут вимірювання в мікросекундах
 * 
 * Максимальний час очікування відбитого сигналу.
 * 30000 мкс відповідає максимальній відстані ~5 метрів.
 * 
 * Розрахунок: 
 * - Швидкість звуку = 340 м/с = 29 мкс/см (в один бік)
 * - Для 500 см туди-назад: 500 * 2 / 340 * 10^6 ≈ 29400 мкс
 */
#define DISTANCE_SENSOR_TIMEOUT_US      30000UL

/**
 * @brief Максимальна відстань в сантиметрах
 * 
 * Обмеження діапазону вимірювань датчика для уникнення
 * неправдивих показань на великих відстанях.
 */
#define DISTANCE_SENSOR_MAX_CM          400

/**
 * @brief Максимальна відстань в дюймах
 * 
 * Еквівалент 400 см = 157.48 дюймів ≈ 157 дюймів.
 */
#define DISTANCE_SENSOR_MAX_INCH        157


//================== FUNCTIONS PROTOTYPES ==================

/**
 * @brief Ініціалізація підсистеми датчика відстані
 * 
 * Виконує налаштування GPIO та таймера для роботи з
 * ультразвуковим датчиком:
 * - Налаштування пінів TRIG та ECHO
 * - Ініціалізація таймера для вимірювання тривалості імпульсу
 * - Встановлення початкового стану
 * 
 * @note Має викликатись один раз при старті системи
 *       перед першим використанням distance_sensor_measure_raw()
 * 
 * @see distance_sensor_measure_raw()
 */
void initialize_distance_sensor(void);

/**
 * @brief Вимірювання часу відбиття ультразвукового сигналу
 * 
 * Функція виконує наступні кроки:
 * 1. Генерує тригерний імпульс (10 мкс)
 * 2. Очікує rising edge сигналу ECHO
 * 3. Вимірює тривалість HIGH рівня ECHO
 * 4. Повертає час у мікросекундах
 * 
 * Час вимірювання відповідає подвійній відстані до об'єкта
 * (сигнал проходить туди і назад).
 * 
 * @return Тривалість імпульсу ECHO в мікросекундах
 * @retval 0 Об'єкт не виявлено або перевищено таймаут
 * @retval >0 Виміряний час (58-23200 мкс для 1-400 см)
 * 
 * @note Функція блокуюча - виконання зупиняється до завершення
 *       вимірювання або таймауту (~30 мс максимум)
 * 
 * @warning Між послідовними вимірюваннями необхідна пауза
 *          мінімум 60 мс для стабілізації датчика
 * 
 * @see distance_sensor_convert_to_cm()
 * @see distance_sensor_convert_to_inch()
 * @see DISTANCE_SENSOR_TIMEOUT_US
 */
uint16_t distance_sensor_measure_raw(void);

/**
 * @brief Конвертація часу у відстань в сантиметрах
 * 
 * Перетворює виміряний час відбиття у відстань до об'єкта.
 * 
 * Формула: distance = time_us / 58
 * Пояснення:
 * - Швидкість звуку = 340 м/с = 0.034 см/мкс
 * - Туди-назад: 0.034 * 2 = 0.0588 см/мкс
 * - Інверсія: 1 см = 58.8 мкс ≈ 58 мкс/см
 * 
 * @param[in] raw_time Виміряний час у мікросекундах
 *                     (результат distance_sensor_measure_raw)
 * 
 * @return Відстань до об'єкта в сантиметрах
 * 
 * @see distance_sensor_measure_raw()
 * @see DISTANCE_SENSOR_MAX_CM
 */
uint16_t distance_sensor_convert_to_cm(uint16_t raw_time);

/**
 * @brief Конвертація часу у відстань в дюймах
 * 
 * Перетворює виміряний час відбиття у відстань до об'єкта.
 * 
 * Формула: distance = time_us / 148
 * Пояснення:
 * - 1 дюйм = 2.54 см
 * - Час для 1 дюйма = 58 * 2.54 ≈ 148 мкс/дюйм
 * 
 * @param[in] raw_time Виміряний час у мікросекундах
 *                     (результат distance_sensor_measure_raw)
 * 
 * @return Відстань до об'єкта в дюймах
 * 
 * 
 * @see distance_sensor_measure_raw()
 * @see DISTANCE_SENSOR_MAX_INCH
 */
uint16_t distance_sensor_convert_to_inch(uint16_t raw_time);

#endif /* __DISTANCE_SENSOR_H */