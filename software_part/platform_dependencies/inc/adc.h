/**
 * @file    adc.h
 * @author  Olexandr Makedonskyi
 * @brief   Драйвер аналого-цифрового перетворювача (ADC)
 * @date    13.01.2026
 * @version 1.0
 * 
 * Модуль забезпечує низькорівневий інтерфейс для роботи з ADC
 * мікроконтролера STM8S. Підтримує одноканальне зчитування
 * аналогових сигналів з 10-бітною роздільною здатністю.
 * 
 * Апаратна конфігурація:
 * - Контролер: ADC1
 * - Роздільна здатність: 10 біт (0-1023)
 * - Вирівнювання: право (LSB у молодшому регістрі)
 * 
 * @note Модуль призначений для внутрішнього використання
 *       іншими драйверами (buttons, sensors, тощо)
 */


#ifndef ADC_H
#define ADC_H

//==================== INCLUDES ========================

#include "stm8s.h"

//==================== DEFINES =========================

/**
 * @brief Номер каналу ADC1 Channel 3
 * 
 * Вибір третього каналу ADC (PD2) для зчитування
 * аналогового сигналу.
 */
#define ADC1_CHANNEL_3   (uint8_t)0x03

/**
 * @brief Біт вирівнювання даних ADC
 * 
 * Встановлення цього біту вмикає праве вирівнювання результату:
 * LSB розміщується в регістрі DRL, MSB - в DRH.
 */
#define ADC1_CR2_ALIGN   ((uint8_t)0x08)

/**
 * @brief Біт увімкнення ADC
 * 
 * Встановлення біту ADON в CR1 виконує дві функції:
 * - Перше встановлення: увімкнення живлення ADC
 * - Повторне встановлення: запуск конверсії
 */
#define ADC1_CR1_ADON    ((uint8_t)0x01)

/**
 * @brief Біт завершення конверсії
 * 
 * Прапорець EOC (End Of Conversion) встановлюється апаратно
 * після завершення аналого-цифрового перетворення.
 * Має бути скинутий програмно перед наступним зчитуванням.
 */
#define ADC1_CSR_EOC     ((uint8_t)0x80)


//================== FUNCTIONS PROTOTYPES ==================

/**
 * @brief Ініціалізація модуля ADC
 * 
 * Виконує налаштування ADC1 для роботи з аналоговими входами:
 * - Вибір каналу ADC1_CHANNEL_3
 * - Налаштування правого вирівнювання результату
 * - Увімкнення живлення ADC
 * 
 * @note Функція має викликатись один раз при старті системи
 *       перед першим зчитуванням ADC
 * 
 * @warning Після ініціалізації необхідно зачекати мінімум
 *          7 мкс перед першою конверсією (час стабілізації)
 * 
 * @see adc_start_single_conversion()
 * @see adc_read()
 */
void     initialize_adc(void);

/**
 * @brief Запуск одиничної конверсії ADC
 * 
 * Ініціює процес аналого-цифрового перетворення на обраному
 * каналі. Після запуску необхідно дочекатись встановлення
 * прапорця EOC перед зчитуванням результату.
 * 
 * Час конверсії залежить від налаштувань тактування та
 * становить приблизно 14 тактів ADC (типово ~14 мкс при 1 МГц).
 * 
 * @note ADC має бути попередньо ініціалізований
 *       викликом initialize_adc()
 * 
 * @warning Не запускайте нову конверсію до завершення попередньої
 * 
 * @see adc_read()
 * @see ADC1_CSR_EOC
 */
void     adc_start_single_conversion(void);

/**
 * @brief Зчитування результату конверсії ADC
 * 
 * Виконує блокуюче очікування завершення конверсії та
 * зчитування 10-бітного результату з регістрів DRL/DRH.
 * 
 * Послідовність операцій:
 * 1. Очікування встановлення прапорця EOC
 * 2. Скидання прапорця EOC
 * 3. Зчитування молодшого байту (DRL)
 * 4. Зчитування старшого байту (DRH)
 * 5. Об'єднання результату
 * 
 * @return 10-бітне значення АЦП (0-1023)
 * 
 * @note Функція блокуюча - виконання зупиняється до
 *       завершення конверсії (~14 мкс при 1 МГц ADC)
 * 
 * @warning Молодший байт (DRL) ОБОВ'ЯЗКОВО має читатись першим
 *          для коректної роботи апаратного захисту від race condition
 * 
 * @see adc_start_single_conversion()
 */
uint16_t adc_read(void);



#endif