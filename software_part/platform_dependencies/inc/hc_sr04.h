/**
 * @file    hc_sr04.h
 * @author  Olexandr Makedonskyi
 * @brief   HAL драйвер ультразвукового датчика HC-SR04
 * @date    13.01.2026
 * @version 1.0
 * 
 * Модуль забезпечує низькорівневий інтерфейс для роботи з
 * ультразвуковим датчиком відстані HC-SR04.
 * 
 * Апаратна конфігурація:
 * - Датчик: HC-SR04 (ультразвуковий далекомір)
 * - TRIG: PB4 (GPIO вихід, Push-Pull, High Speed)
 * - ECHO: PA3 (TIM2_CH3 вхід для Input Capture)
 * - Таймер: TIM2 з prescaler /16 → 1 мкс per tick
 * - Частота CPU: 16 МГц
 * 
 * Принцип роботи HC-SR04:
 * 1. Подати імпульс 10 мкс на TRIG
 * 2. Датчик генерує 8 циклів 40 кГц ультразвуку
 * 3. ECHO переходить в HIGH
 * 4. Після відбиття сигналу ECHO переходить в LOW
 * 5. Тривалість HIGH = час проходження звуку туди-назад
 * 
 * Тайминг сигналів:
 * - TRIG імпульс: 10 мкс мінімум
 * - ECHO затримка: 100-25000 мкс (2-430 см)
 * - Цикл вимірювання: мінімум 60 мс між вимірюваннями
 * 
 * @note Модуль призначений для використання драйверами
 *       вищого рівня (sensor.h)
 */


#ifndef __HCSR04_H
#define __HCSR04_H

//==================== INCLUDES ========================

#include "stm8s.h"
#include "delays.h"

//==================== DEFINES =========================

/**
 * @brief Порт GPIO для піну TRIG
 */
#define HCSR04_TRIG_PORT        GPIOB

/**
 * @brief Номер піна TRIG (PB4)
 * 
 * Використовується для генерації тригерного імпульсу.
 */
#define HCSR04_TRIG_PIN         (1 << 4)

/**
 * @brief Порт GPIO для піну ECHO
 */
#define HCSR04_ECHO_PORT        GPIOA

/**
 * @brief Номер піна ECHO (PA3)
 * 
 * Підключений до TIM2_CH3 для вимірювання тривалості імпульсу.
 */
#define HCSR04_ECHO_PIN         (1 << 3)

/**
 * @brief Тривалість тригерного імпульсу в мікросекундах
 * 
 * Мінімальна тривалість за специфікацією HC-SR04 = 10 мкс.
 */
#define HCSR04_TRIGGER_PULSE_US 10


//================== FUNCTIONS PROTOTYPES ==================

/**
 * @brief Ініціалізація GPIO та таймера для роботи з HC-SR04
 * 
 * Виконує повну ініціалізацію апаратних ресурсів:
 * 
 * GPIO налаштування:
 * - TRIG (PB4): вихід, Push-Pull, High Speed, початковий стан LOW
 * - ECHO (PA3): вхід, Floating (без підтяжки)
 * 
 * Таймер TIM2 налаштування:
 * - Prescaler: /16 (1 МГц → 1 тік = 1 мкс)
 * - Auto-reload: 0xFFFF (65535 мкс циклу)
 * - CH3 режим: Input Capture (захоплення фронтів)
 * - Початковий стан: захоплення rising edge
 * 
 * @note Функція має викликатись один раз перед першим
 *       використанням hcsr04_measure_pulse()
 * 
 * @warning Після ініціалізації необхідно зачекати мінімум
 *          1 мс перед першим вимірюванням (ініціалізація датчика)
 * 
 * @see hcsr04_measure_pulse()
 */
void hcsr04_gpio_init(void);


/**
 * @brief Вимірювання тривалості імпульсу ECHO
 * 
 * Виконує повний цикл вимірювання відстані:
 * 1. Генерує тригерний імпульс (10 мкс)
 * 2. Очікує rising edge на ECHO (початок імпульсу)
 * 3. Захоплює значення таймера (rise_time)
 * 4. Перемикається на детекцію falling edge
 * 5. Очікує falling edge на ECHO (кінець імпульсу)
 * 6. Захоплює значення таймера (fall_time)
 * 7. Обчислює тривалість: pulse_width = fall_time - rise_time
 * 
 * Input Capture використовує TIM2_CH3:
 * - Rising edge: CC3P=0, CC3E=1 (CCER2 = 0x01)
 * - Falling edge: CC3P=1, CC3E=1 (CCER2 = 0x03)
 * - Захоплені значення зберігаються в CCR3H:CCR3L
 * 
 * @param[in] timeout_us Максимальний час очікування в мікросекундах
 *                       Типово: 30000 мкс (для відстані до 5 м)
 * 
 * @return Тривалість імпульсу ECHO в мікросекундах
 * @retval 0 Таймаут або помилка вимірювання (об'єкт не виявлено)
 * @retval >0 Виміряна тривалість імпульсу (58-23200 мкс для 1-400 см)
 * 
 * @note Функція блокуюча - виконання зупиняється до завершення
 *       вимірювання або таймауту
 * 
 * @note Між послідовними викликами необхідна пауза мінімум 60 мс
 *       для стабілізації датчика
 * 
 * @warning При таймауті функція відновлює початковий стан таймера
 *          (CCER2 = 0x01 для наступного вимірювання)
 * 
 * @see hcsr04_send_trigger()
 */
uint16_t hcsr04_measure_pulse(uint32_t timeout_us);

#endif /* __HCSR04_H */