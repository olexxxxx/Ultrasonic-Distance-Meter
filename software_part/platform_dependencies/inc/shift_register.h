/**
 * @file    shift_register.h
 * @author  Olexandr Makedonskyi
 * @brief   Драйвер зсувового регістру 74HC595
 * @date    13.01.2026
 * @version 1.0
 * 
 * 
 * Модуль забезпечує низькорівневий інтерфейс для роботи з
 * 8-бітним послідовним зсувовим регістром 74HC595.
 * 
 * Апаратна конфігурація:
 * - Мікросхема: 74HC595 (Serial-In, Parallel-Out)
 * - Інтерфейс: Програмна серіалізація (Bit-Banging)
 * - Порти GPIO: GPIOC (PC5, PC6, PC7)
 * - Швидкість GPIO: 10 МГц (High Speed)
 * 
 * Призначення пінів:
 * - DS (Data Serial):      PC5 → вхід даних регістру зсуву
 * - SH_CP (Shift Clock):   PC6 → тактування зсуву (rising edge)
 * - ST_CP (Storage Clock): PC7 → фіксація даних на виході (latch)
 * 
 * Принцип роботи:
 * 1. Дані подаються на DS біт за бітом (MSB first)
 * 2. Кожен біт зсувається в регістр по rising edge SH_CP
 * 3. Після передачі всіх 8 біт, імпульс ST_CP переносить
 *    дані з регістру зсуву в регістр виходу (Q0-Q7)
 * 
 * @note Модуль призначений для використання драйверами
 *       вищого рівня (indication, display, тощо)
 */



#ifndef SHIFT_REG_H
#define SHIFT_REG_H


//==================== INCLUDES ========================

#include "stm8s.h"

//==================== DEFINES =========================

/**
 * @brief Порт GPIO для підключення 74HC595
 * 
 * Всі три сигнали (DS, SH_CP, ST_CP) підключені до GPIOC.
 */
#define SR_PORT GPIOC

/**
 * @brief Піновий номер DS (Data Serial) - PC5
 * 
 * Лінія послідовних даних для передачі біт у регістр зсуву.
 * Дані фіксуються по rising edge тактового сигналу SH_CP.
 */
#define SR_DATA_PIN  (1 << 5)

/**
 * @brief Піновий номер SH_CP (Shift Clock) - PC6
 * 
 * Тактовий сигнал регістру зсуву. По rising edge виконується
 * зсув даних з DS у внутрішній регістр мікросхеми.
 */
#define SR_CLK_PIN   (1 << 6) // PC6

/**
 * @brief Піновий номер ST_CP (Storage Clock / Latch) - PC7
 * 
 * Тактовий сигнал регістру зберігання. По rising edge дані
 * переносяться з регістру зсуву на паралельні виходи Q0-Q7.
 */
#define SR_LATCH_PIN (1 << 7) // PC7

//================== FUNCTIONS PROTOTYPES ==================

/**
 * @brief Ініціалізація GPIO для роботи зі зсувовим регістром
 * 
 * Налаштовує піни PC5, PC6, PC7 для керування 74HC595:
 * 1. Скидання бітів напрямку (безпека)
 * 2. Встановлення режиму виходу (DDR = 1)
 * 3. Налаштування Push-Pull (CR1 = 1)
 * 4. Встановлення високої швидкості 10 МГц (CR2 = 1)
 * 5. Встановлення початкового стану LOW
 * 
 * Режим Push-Pull забезпечує:
 * - Активне керування HIGH і LOW рівнями
 * - Відсутність потреби в зовнішніх підтягуючих резисторах
 * - Швидке перемикання (важливо для тактових сигналів)
 * 
 * @note Функція має викликатись один раз перед першим
 *       використанням shift_reg_send()
 * 
 * @warning Після ініціалізації всі виходи Q0-Q7 знаходяться
 *          в невизначеному стані до першої відправки даних
 * 
 * @see shift_reg_send()
 */
void shift_reg_init(void);

/**
 * @brief Відправка байта даних у зсувовий регістр
 * 
 * Виконує серіалізацію та передачу 8-бітного значення в
 * регістр 74HC595 з наступним фіксуванням на виході.
 * 
 * Алгоритм передачі:
 * 1. Опускання ST_CP (latch) - початок транзакції
 * 2. Для кожного біту (MSB → LSB):
 *    a. Встановлення DS (data line) в 0 або 1
 *    b. Імпульс SH_CP (rising edge) - зсув біту
 * 3. Піднімання ST_CP - фіксація даних на Q0-Q7
 * 
 * Порядок передачі: MSB First (біт 7 → біт 0)
 * - Біт 7 (data & 0x80) → вихід Q7
 * - Біт 6 (data & 0x40) → вихід Q6
 * - ...
 * - Біт 0 (data & 0x01) → вихід Q0
 * 
 * @param[in] data Байт для відображення на виходах Q0-Q7
 *                 - 0x00: всі виходи LOW
 *                 - 0xFF: всі виходи HIGH
 *                 - Інше: індивідуальне керування кожним битом
 * 
 * @note Функція виконується синхронно. Час виконання:
 *       ~50-100 мкс залежно від частоти CPU
 * 
 * @warning GPIO має бути попередньо ініціалізований
 *          викликом shift_reg_init()
 * 
 * @see shift_reg_init()
 */
void shift_reg_send(uint8_t data);

#endif /* __SHIFT_REGISTER_H */