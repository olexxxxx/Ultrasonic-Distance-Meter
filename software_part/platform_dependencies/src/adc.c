/**
 * @file    adc.c
 * @author  Olexandr Makedonskyi
 * @brief   Реалізація драйвера аналого-цифрового перетворювача
 * @date    13.01.2026
 * @version 1.0
 * 
 * Модуль реалізує низькорівневі функції для роботи з ADC1
 * мікроконтролера STM8S. Забезпечує ініціалізацію, запуск
 * конверсії та зчитування результатів.
 * 
 * Особливості реалізації:
 * - Синхронний (блокуючий) режим роботи
 * - Одноканальне зчитування
 * - Ручне керування конверсією
 * - Праве вирівнювання 10-бітного результату
 * 
 * @note Для розширення функціоналу (DMA, переривання, сканування)
 *       необхідно модифікувати initialize_adc()
 */


//==================== INCLUDES ========================

#include "adc.h"

//============ PUBLIC FUNCTIONS =========================


void initialize_adc(void){
	// Налаштовуємо АЦП
	ADC1->CSR |= 	ADC1_CHANNEL_3; 		 // Вибір каналу для зчитування (Channel 3)
	ADC1->CR2 = 	ADC1_CR2_ALIGN; 		 // Налаштування правого вирівнювання (LSB у молодшому регістрі)
	ADC1->CR1 = 	ADC1_CR1_ADON; 			 // Увімкнення живлення ADC
}


void adc_start_single_conversion(void){
	ADC1->CR1 |= ADC1_CR1_ADON;				 // Запуск конверсії (повторне встановлення біту ADON)
}


uint16_t adc_read(void){
	uint16_t result;
	while ((ADC1->CSR & ADC1_CSR_EOC) == 0); // Очікування завершення конверсії (polling EOC)
	ADC1->CSR &= ~ADC1_CSR_EOC;				 // Скидання прапорця завершення
	
	result = ADC1->DRL;						 // Зчитування результату (молодший байт ПЕРШИМ!)
	result |= (ADC1->DRH << 8);

	return result;
}


